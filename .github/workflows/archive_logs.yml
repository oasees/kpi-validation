name: Archive Workflow Logs

# Trigger this workflow only when the "KPI Validation" workflow completes
on:
    workflow_run:
        workflows: [
                "Concurrent nodes and services",
                "Deployment time",
                "Distributed service",
                "Marketplace PoC",
            ] # MUST match the 'name' of your testing workflow
        types:
            - completed

permissions:
    contents: write
    actions: read
jobs:
    archive-logs:
        runs-on: ubuntu-latest
        if: ${{ github.event.workflow_run.conclusion == 'success' }}
        steps:
            - name: Checkout Code
              uses: actions/checkout@v4

            - name: Download and Extract Logs
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  RUN_ID: ${{ github.event.workflow_run.id }}
                  REPO: ${{ github.repository }}
                  WORKFLOW_NAME: ${{ github.event.workflow_run.name }}
              run: |
                  # Sanitize the workflow name to make it folder-safe
                  # "KPI Validation" becomes "KPI_Validation"
                  SAFE_NAME=$(echo "$WORKFLOW_NAME" | tr ' ' '_' | tr -cd '[:alnum:]_-')

                  # Define the target path
                  TARGET_DIR="evidence/$SAFE_NAME/run-$RUN_ID"

                  # 1. Download the log zip via API
                  gh api -H "Accept: application/vnd.github+json" \
                    /repos/$REPO/actions/runs/$RUN_ID/logs > logs.zip

                  # 2. Create the specific directory structure
                  mkdir -p "$TARGET_DIR"

                  # 3. Unzip directly into that folder
                  unzip -o -q logs.zip -d "$TARGET_DIR"

                  # 4. Cleanup
                  rm logs.zip

            - name: Commit Official Logs
              env:
                  WORKFLOW_NAME: ${{ github.event.workflow_run.name }}
              run: |
                  git config --global user.name 'github-actions[bot]'
                  git config --global user.email 'github-actions[bot]@users.noreply.github.com'

                  # Add the entire evidence folder (git handles new subfolders automatically)
                  git add evidence/

                  git commit -m "Audit: Archive logs for '$WORKFLOW_NAME' (Run ID ${{ github.event.workflow_run.id }})"
                  git push
